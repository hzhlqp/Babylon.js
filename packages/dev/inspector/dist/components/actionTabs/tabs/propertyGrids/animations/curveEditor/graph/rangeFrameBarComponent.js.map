{"version":3,"file":"rangeFrameBarComponent.js","sourceRoot":"","sources":["../../../../../../../../src/components/actionTabs/tabs/propertyGrids/animations/curveEditor/graph/rangeFrameBarComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { Nullable } from \"core/types\";\r\nimport * as React from \"react\";\r\nimport type { GlobalState } from \"../../../../../../globalState\";\r\nimport type { Context, IActiveAnimationChangedOptions } from \"../context\";\r\nimport type { Animation } from \"core/Animations/animation\";\r\nimport type { Observer } from \"core/Misc/observable\";\r\n\r\nconst tickDistance = 25; // x distance between consecutive ticks\r\n\r\ninterface IRangeFrameBarComponentProps {\r\n    globalState: GlobalState;\r\n    context: Context;\r\n}\r\n\r\ninterface IRangeFrameBarComponentState {}\r\n\r\nexport class RangeFrameBarComponent extends React.Component<IRangeFrameBarComponentProps, IRangeFrameBarComponentState> {\r\n    private _svgHost: React.RefObject<SVGSVGElement>;\r\n    private _viewWidth = 748;\r\n    private _offsetX = 10;\r\n    private _isMounted = false;\r\n\r\n    private _onActiveAnimationChangedObserver: Nullable<Observer<IActiveAnimationChangedOptions>>;\r\n    private _onPlayheadMovedObserver: Nullable<Observer<number>>;\r\n    private _onFrameManuallyEnteredObserver: Nullable<Observer<number>>;\r\n\r\n    constructor(props: IRangeFrameBarComponentProps) {\r\n        super(props);\r\n\r\n        this.state = {};\r\n\r\n        this._svgHost = React.createRef();\r\n\r\n        this.props.context.onHostWindowResized.add(() => {\r\n            this._computeSizes();\r\n        });\r\n\r\n        this._onActiveAnimationChangedObserver = this.props.context.onActiveAnimationChanged.add(() => {\r\n            if (!this._isMounted) {\r\n                return;\r\n            }\r\n\r\n            this._computeSizes();\r\n            this.forceUpdate();\r\n        });\r\n\r\n        this._onPlayheadMovedObserver = this.props.context.onPlayheadMoved.add(() => {\r\n            this.forceUpdate();\r\n        });\r\n\r\n        this.props.context.onFrameSet.add(() => {\r\n            if (!this._isMounted) {\r\n                return;\r\n            }\r\n\r\n            this.forceUpdate();\r\n        });\r\n\r\n        this._onFrameManuallyEnteredObserver = this.props.context.onFrameManuallyEntered.add(() => {\r\n            if (!this._isMounted) {\r\n                return;\r\n            }\r\n\r\n            this.forceUpdate();\r\n        });\r\n\r\n        this.props.context.onRangeUpdated.add(() => {\r\n            if (!this._isMounted) {\r\n                return;\r\n            }\r\n\r\n            this.forceUpdate();\r\n        });\r\n    }\r\n\r\n    override componentDidMount() {\r\n        this._isMounted = true;\r\n    }\r\n\r\n    override componentWillUnmount() {\r\n        if (this._onActiveAnimationChangedObserver) {\r\n            this.props.context.onActiveAnimationChanged.remove(this._onActiveAnimationChangedObserver);\r\n        }\r\n        if (this._onPlayheadMovedObserver) {\r\n            this.props.context.onPlayheadMoved.remove(this._onPlayheadMovedObserver);\r\n        }\r\n        if (this._onFrameManuallyEnteredObserver) {\r\n            this.props.context.onFrameManuallyEntered.remove(this._onFrameManuallyEnteredObserver);\r\n        }\r\n\r\n        this._isMounted = false;\r\n    }\r\n\r\n    private _computeSizes() {\r\n        if (!this._svgHost.current) {\r\n            return;\r\n        }\r\n\r\n        this._viewWidth = this._svgHost.current.clientWidth;\r\n        this.props.context.onRangeFrameBarResized.notifyObservers(this._viewWidth);\r\n        this.forceUpdate();\r\n    }\r\n\r\n    private _dropKeyFrames(animation: Animation) {\r\n        const from = this.props.context.fromKey;\r\n        const to = this.props.context.toKey;\r\n        const range = to - from;\r\n        const convertRatio = range / this._viewWidth;\r\n\r\n        const keys = animation.getKeys();\r\n\r\n        return keys.map((k, i) => {\r\n            const x = (k.frame - from) / convertRatio;\r\n            return (\r\n                <line\r\n                    key={\"frame-line\" + k.frame + i}\r\n                    x1={x}\r\n                    y1=\"0px\"\r\n                    x2={x}\r\n                    y2=\"40px\"\r\n                    style={{\r\n                        stroke: \"#ffc017\",\r\n                        strokeWidth: 0.5,\r\n                    }}\r\n                ></line>\r\n            );\r\n        });\r\n    }\r\n\r\n    private _buildActiveFrame() {\r\n        if (this.props.context.activeFrame === null || this.props.context.activeFrame === undefined) {\r\n            return null;\r\n        }\r\n\r\n        const from = this.props.context.fromKey;\r\n        const to = this.props.context.toKey;\r\n\r\n        const range = to - from;\r\n        const convertRatio = range / this._viewWidth;\r\n\r\n        const x = (this.props.context.activeFrame - from) / convertRatio;\r\n\r\n        return (\r\n            <line\r\n                key={\"line-activeFrame\"}\r\n                x1={x}\r\n                y1=\"0px\"\r\n                x2={x}\r\n                y2=\"40px\"\r\n                style={{\r\n                    stroke: \"#ffffff\",\r\n                    strokeWidth: 0.5,\r\n                }}\r\n            ></line>\r\n        );\r\n    }\r\n\r\n    private _buildFrames() {\r\n        if (this.props.context.activeAnimations.length === 0) {\r\n            return null;\r\n        }\r\n\r\n        const from = this.props.context.fromKey;\r\n        const to = this.props.context.toKey;\r\n\r\n        const range = to - from;\r\n        const convertRatio = range / this._viewWidth;\r\n        const dist = tickDistance;\r\n        const offset = Math.max(Math.floor(dist * convertRatio), 1);\r\n\r\n        const steps = [];\r\n\r\n        const start = from;\r\n        const end = start + range;\r\n\r\n        for (let step = start; step <= end; step += offset) {\r\n            steps.push(step);\r\n        }\r\n\r\n        if (steps[steps.length - 1] < end - offset / 2) {\r\n            steps.push(end);\r\n        }\r\n\r\n        return steps.map((s, i) => {\r\n            const x = (s - from) / convertRatio;\r\n            return (\r\n                <g key={\"axis\" + s + i}>\r\n                    <line\r\n                        key={\"line\" + s + i}\r\n                        x1={x}\r\n                        y1=\"22px\"\r\n                        x2={x}\r\n                        y2=\"40px\"\r\n                        style={{\r\n                            stroke: \"#333333\",\r\n                            strokeWidth: 0.5,\r\n                        }}\r\n                    ></line>\r\n                    <text\r\n                        key={\"label\" + s + i}\r\n                        x={x}\r\n                        y={0}\r\n                        dx=\"6px\"\r\n                        textAnchor=\"middle\"\r\n                        dy=\"14px\"\r\n                        style={{\r\n                            fontFamily: \"acumin-pro-condensed\",\r\n                            fontSize: `12px`,\r\n                            fill: \"#555555\",\r\n                            textAlign: \"center\",\r\n                        }}\r\n                    >\r\n                        {s.toFixed(0)}\r\n                    </text>\r\n                </g>\r\n            );\r\n        });\r\n    }\r\n\r\n    public override render() {\r\n        const viewBox = `${-this._offsetX} 0 ${this._viewWidth + this._offsetX * 4} 40`;\r\n\r\n        return (\r\n            <div id=\"range-frame-bar\">\r\n                <svg id=\"svg-range-frames\" viewBox={viewBox} ref={this._svgHost}>\r\n                    {this._buildFrames()}\r\n                    {this.props.context.activeAnimations.map((a) => {\r\n                        return this._dropKeyFrames(a);\r\n                    })}\r\n                    {this._buildActiveFrame()}\r\n                </svg>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n"]}